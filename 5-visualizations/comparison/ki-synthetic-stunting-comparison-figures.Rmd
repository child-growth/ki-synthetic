---
title: "Synthetic comparison figures"
author: "Andrew Mertens"
date: "6/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

library(tidyverse)
library(here)
library(knitr)

theme_ki <- function() {
  theme_bw() %+replace%
    theme(
      strip.background = element_blank(),
      #legend.position="none",
      plot.title = element_text(size = 16, face = "bold"),
      strip.text = element_text(size=14),
      axis.title = element_text(size=12),
      axis.text.y = element_text(size=10),
      axis.text.x = element_text(size=10, angle = 0, hjust = 0.5, vjust=.1)
    )
}

theme_set(theme_ki())

```


```{r, include="F"}
fig_dir="C:/Users/andre/Documents/HBGDki/ki-synthetic/figures/"

pPAR <- readRDS("C:/Users/andre/Documents/HBGDki/ki-synthetic/results/rf results/rf_Zpar_plot_objects.RDS")
pATE <- readRDS(paste0(here::here(), "/results/rf results/ate_diff_object.RDS"))
pPAR_unadj <- readRDS("C:/Users/andre/Documents/HBGDki/ki-synthetic/results/rf results/rf_Zpar_unadj_plot_objects.RDS")
pATE_unadj <- readRDS(paste0(here::here(), "/results/rf results/ate_diff_object_unadj.RDS"))


load("C:/Users/andre/Documents/HBGDki/ki-synthetic/figures/wasting/fig-comparisons.Rdata")
WLZ_plot <- Z_plot
wast_plot <-prev_plot
wast_ci_plot <-ci_plot
wast_ci_africa_plot <-ci_plot_Africa
#sevwast_plot

load("C:/Users/andre/Documents/HBGDki/ki-synthetic/figures/stunting/fig-comparisons.Rdata")
LAZ_plot <- Z_plot
stunt_plot <- prev_plot_pooled
sevstunt_plot <- prev_plot_sev
stunt_ci_plot <- ci_plot
stunt_prev_cohort <- prev_plot



pwhz <- readRDS(file=paste0(fig_dir, "plot-objects/fig-WLZ-comp.RDS"))
phaz <- readRDS(file=paste0(fig_dir, "plot-objects/fig-LAZ-comp.RDS"))


```

## Dataset descriptions

The report compares estimates from 3 synthetic datasets with the raw KI values. The synthetic datasets are labeled:

  *  QI: Partially synthetic dataset with just quasi-identifiers synthesized
  *  BC: Partially synthetic dataset with quasi-identifiers and baseline characteristics synthesized, but not child age/anthropometry
  *  Full: Fully synthesized dataset using updated deep learning model. Each cohort is generated through a model either trained exclusively on that cohort, or on a group of sufficiently similar cohorts, depending on the number of individuals in the cohort.
  


## Descriptive epidemiology comparisons of Z-scores and age-specific wasting and stunting prevalences/incidences


Anthropometry estimates match exactly between the real data and the QI/BC datasets, but while mean Z-scores from the fully synthetic data match overall (and mostly match by age), the prevalences and incidences of wasting and stunting are lower because the standard deviation of Z-scores in the full synthetic data is lower than the real. 


```{r, echo=FALSE}

synfull <- readRDS(here("data/ki-synthetic-dataset.rds"))
  tab<- synfull %>% group_by(syntype) %>%
    summarize(`Mean HAZ`=round(mean(haz, na.rm=T),2), `Mean WHZ`=round(mean(whz, na.rm=T),2), `SD HAZ`=round(sd(haz, na.rm=T),2), `SD WHZ`=round(sd(whz, na.rm=T),2))
    
knitr::kable(tab)
  
```


### Mean Z-scores


```{r, echo=FALSE, fig.height = 6, fig.width = 8, fig.align = "center"}

LAZ_plot
WLZ_plot


```


<!-- # ```{r, echo=FALSE, fig.height = 6, fig.width = 8, fig.align = "center"} -->
<!-- #  -->
<!-- # phaz -->
<!-- # pwhz -->
<!-- #  -->
<!-- # ``` -->
<!-- #  -->
<!-- # __Note:__ `Recalculated` are Z-scores calculated using the growthstandard() R package from the synthetic height, weight, and age variables, versus the `Synthetic` Z-scores, which are the directly-synthesized Z-scores.  -->


### Stunting  prevalence

```{r, echo=FALSE, fig.height = 6, fig.width = 8, fig.align = "center"}

#Stunting
stunt_plot$plot




```

Note slight difference in stunting prevalence between real and QI/BC data. These should match exactly so I'm digging deeper to see if there is a slight different in code (most likely) or an actual difference in the underlying data affecting the prevalence estimates.

### Wasting prevalence

```{r, echo=FALSE, fig.height = 6, fig.width = 8, fig.align = "center"}


#Wasting
wast_plot$plot


```

### Severe stunting prevalence


```{r, echo=FALSE, fig.height = 6, fig.width = 8, fig.align = "center"}
#Stunting
sevstunt_plot$plot



```

### Severe  wasting prevalence


```{r, echo=FALSE, fig.height = 6, fig.width = 8, fig.align = "center"}

#Wasting
sevwast_plot$plot

```

### Stunting  cumulative incidence


```{r, echo=FALSE, fig.height = 6, fig.width = 8, fig.align = "center"}

#Stunting
stunt_ci_plot$plot


```


### Wasting cumulative incidence


```{r, echo=FALSE, fig.height = 6, fig.width = 8, fig.align = "center"}

wast_ci_plot$plot
```


### Example cohort-specific estimates of wasting cumulative incidenc eby age


```{r, echo=FALSE, fig.height = 6, fig.width = 8, fig.align = "center"}

wast_ci_africa_plot$plot

```

The fully synthesized data matches much more closely in some cohorts than others.


## Covariate-adjusted, SuperLearner-based estimates

Below are comparisons of the most challenging resutls to replicate with synthetic data

### Comparison of pooled targeted learning estimates


```{r, echo=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

pPAR[[1]]
pPAR[[2]]
```


### Comparison of difference in cohort-specific targeted learning estimates

Note "BC" estimates match the real-data estimates almost exactly and are not plotted

```{r, echo=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

pATE
```


## Unadjusted, linear regression estimates

### Comparison of pooled targeted learning estimates


```{r, echo=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

pPAR_unadj[[1]]
pPAR_unadj[[2]]
```


### Comparison of difference in cohort-specific targeted learning estimates

Note "BC" estimates match the real-data estimates almost exactly and are not plotted

```{r, echo=FALSE, fig.height = 8, fig.width = 8, fig.align = "center"}

pATE_unadj
```


